<Sql TableName="v_CKARRDetail" CustomScript="#CDATA">
    <CDATA name="CustomScript"><![CDATA[IF EXISTS
(
	SELECT *
	FROM SYS.views
	WHERE name = 'CKARRDetail' AND SCHEMA_ID = SCHEMA_ID('dbo')
)
DROP VIEW [dbo].[CKARRDetail]	
GO
CREATE VIEW CKARRDetail AS

-- [A] 先挑 該Customer 的第一筆 WON Opportunity with Campaign　
With OppoListCustomer as 
(
select top 1 with ties
oppob.CompanyID,
oppob.BAccountID,
oppob.OpportunityID,
oppob.CampaignSourceID
 
from CROpportunityRevision as oppob
inner join CROpportunity as oppo
   on oppo.CompanyID = oppob.CompanyID
   and oppo.OpportunityID = oppob.OpportunityID
   and oppo.status = 'W' 
   and oppob.CampaignSourceID is not null

order by row_number() over (partition by oppob.CompanyID, oppob.BAccountID
							order by oppob.OpportunityID desc)

), 

-- [B] 挑每位客戶的前12個月的billing (Filter By [A] WON Opportunity with Campaign)

InvDateCustRange as (
select top 1 with ties
	   AR.CompanyID,
	   AR.CustomerID as BAccountID,
       AR.DocDate as FromDate,
	   DateAdd(year,1,AR.DocDate) as ToDate,
	   OLC.CampaignSourceID,
	   OLC.OpportunityID

from ARRegister as AR	
	inner join OppoListCustomer as OLC 
			on  OLC.CompanyID = AR.CompanyID
			and OLC.BAccountID = AR.CustomerID
			and AR.DocType = 'INV'
	left join ARRegisterKvExt as ARExt
			on  AR.CompanyID = ARExt.CompanyID
			and AR.NoteID = ARExt.RecordID

where ARExt.ValueNumeric <> 1 OR ARExt.ValueNumeric is null  --手工標記 是否排除於ARR計算

order by row_number() over (partition by 
								AR.CompanyID, 
								AR.CustomerID,
								OLC.CampaignSourceID,
								OLC.OpportunityID
							order by AR.DocDate)


),


-- [C] 篩選每個客戶範圍內的Invoice

ARRDetail as (

select 
DR.CompanyID,
DR.BAccountID,
DR.CampaignSourceID,
DR.OpportunityID,
ARI.DocType,
ARI.RefNbr,
ARR.DocDate,
ARR.CuryOrigDocAmt as InvoiceAmt

from  ARInvoice as ARI 
	inner join ARRegister as ARR
			on ARI.CompanyID = ARR.CompanyID
			and ARI.DocType = ARR.DocType
			and ARI.RefNbr = ARR.RefNbr
			and ARI.DocType = 'INV'
	inner join 	InvDateCustRange as DR
			on ARR.CompanyID = DR.CompanyID
			and ARR.CustomerID = DR.BAccountID
			and ARR.DocDate >= DR.FromDate
			and ARR.DocDate < DR.ToDate
)



select * from ARRDetail]]></CDATA>
</Sql>