<Sql TableName="v_CKBillDifference" CustomScript="#CDATA">
    <CDATA name="CustomScript"><![CDATA[IF EXISTS
(
	SELECT *
	FROM SYS.views
	WHERE name = 'CKBillDifference' AND SCHEMA_ID = SCHEMA_ID('dbo')
)
DROP VIEW [dbo].[CKBillDifference]	
GO
CREATE VIEW CKBillDifference AS

With Base as (

select 
ARRegister.CompanyID,
EOMONTH(ARRegister.DocDate) as Date,
ARRegister.CustomerID,
sum(ARRegister.CuryOrigDocAmt) as BillingAmt

from ARRegister 
inner join ARInvoice on  ARRegister.CompanyID = ARInvoice.CompanyID
					 and ARRegister.DocType = ARInvoice.DocType
					 and ARRegister.RefNbr = ARInvoice.RefNbr

where ARRegister.CompanyID > 0

Group By
	ARRegister.CompanyID, 
	EOMONTH(ARRegister.DocDate),
	ARRegister.CustomerID

)

select 
Base.CompanyID,
cast(base.date as DATETIME2(2)) as Date,
Base.CustomerID,
Base.BillingAmt,
isnull(PreBase.BillingAmt,0) as PreBillingAmt
from base 
left join (select CompanyID,
				  EOMONTH(Date,1) as Date,
				  CustomerID,
				  BillingAmt
			from base) as PreBase
						on  Base.CompanyID = PreBase.CompanyID
						and Base.Date = PreBase.Date
						and Base.CustomerID = PreBase.CustomerID]]></CDATA>
</Sql>